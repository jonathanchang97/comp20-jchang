<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>The Private Car Service</title>
  <link rel="stylesheet" href="css/styles.css">
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAXOxRAOjwexv94hL59aY-5Xe4wkI8kX0M&libraries=geometry"></script>
</head>
  
<body onload="init()">
  
  <div id="map"></div>
	<script>
		var myLat = 0, myLng = 0;
		var me = new google.maps.LatLng(myLat, myLng);
			
    var myOptions = {
		  zoom: 13, // The larger the zoom number, the bigger the zoom
		  center: me,
			mapTypeId: google.maps.MapTypeId.ROADMAP
		};

		var map;
		var users;
		var marker;
		var location;
		var infowindow = new google.maps.InfoWindow();
			
		var icons = {
			vehicle: {
				url: "images/car.png",
				scaledSize: new google.maps.Size(50, 50)
			},
      passenger: {
				url: "images/passenger.png",
				scaledSize: new google.maps.Size(50, 50)
			},
      weinermobile: {
				url: "images/weinermobile.png",
				scaledSize: new google.maps.Size(50, 50)
			},
			self: {
				url: "images/yoshi.png",
				scaledSize: new google.maps.Size(50, 50)
      }
    }
    
		function init()
		{
		  map = new google.maps.Map(document.getElementById("map"), myOptions);
			getMyLocation();
    }
			
		function getMyLocation() {
		  if (navigator.geolocation) { // the navigator.geolocation object is supported on your browser
        navigator.geolocation.getCurrentPosition(function(position) {
          myLat = position.coords.latitude;
					myLng = position.coords.longitude;
					renderMap();
				});
		  }
      else
        alert("Geolocation is not supported by your web browser.  What a shame!");
		}
			
		function renderMap() {
		  me = new google.maps.LatLng(myLat, myLng);
      makeRequest();
		  map.panTo(me);
				
			addMarkers();
    }

    function makeRequest()
    {
      "use strict";
      var xhr = new XMLHttpRequest();
      
      xhr.open("Post", "https://hans-moleman.herokuapp.com/rides", true);
      xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
      
      xhr.onreadystatechange = function () {
        if (xhr.readyState === 4 && xhr.status === 200) {
          users = JSON.parse(xhr.responseText);
        } 
        else if (xhr.readyState === 4 && xhr.status !== 200)
          alert("Error: XML request went wrong");
      };
      
      xhr.send("username=XdZjKMkR&lat=" + myLat + "&lng=" + myLng);
    }
			
		function addMarkers()
		{
			// Create self marker
      marker = new google.maps.Marker({
        position: me,
        title: 'XdZjKMkR',
				distance: 0
      });
      marker.setMap(map);
			marker.setIcon(icons['self']);

      // Open info window on click of marker
      google.maps.event.addListener(marker, 'click', function() {
        infowindow.setContent(marker.title);
        infowindow.open(map, marker);
      });
				
				
			if (users.vehicles) {
	    	for (i = 0; i < users.passengers.length; i += 1) {
      		addOtherUsers('passenger', users.passengers[i]);	
				}
			}
				
			if (users.passengers) {
				for (i = 0; i < users.vehicles.length; i += 1) {
					addOtherUsers('vehicle', users.vehicles[i]);
    		}					
			}
		}
			
		function addOtherUsers(type, user)
		{
			location = new google.maps.LatLng(user.lat, user.lng);		
		}
			
  </script> 
</body>
</html>